# FreeGPT API Server - Docker Compose Configuration
#
# Usage:
#   First-time auth:  docker-compose run --rm auth
#   Start server:     docker-compose up -d
#   Stop server:      docker-compose down
#   View logs:        docker-compose logs -f
#   Run tests:        docker-compose run --rm test
#
# IMPORTANT: Before starting the server, you MUST authenticate:
#   docker-compose run --rm auth
# This will guide you through the GitHub Copilot OAuth device flow.

services:
  freegpt-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: freegpt-api
    restart: unless-stopped
    ports:
      - "${PORT:-8000}:${PORT:-8000}"
    environment:
      - HOST=${HOST:-0.0.0.0}
      - PORT=${PORT:-8000}
      - FREEGPT_API_KEY=${FREEGPT_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - PYTHONUNBUFFERED=1
      # Proxy settings (required for accessing GitHub Copilot API in some networks)
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - http_proxy=${HTTP_PROXY:-}
      - https_proxy=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1}
      - no_proxy=${NO_PROXY:-localhost,127.0.0.1}
    volumes:
      # Persistent data - GitHub Copilot token and API tokens
      # Note: .copilot_token must exist and contain valid token before starting
      - ./data:/app/data:rw
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:${PORT:-8000}/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - freegpt-network

  # Authentication service - run this first to set up GitHub Copilot token
  auth:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: freegpt-auth
    environment:
      - PYTHONUNBUFFERED=1
      # Proxy settings (required for accessing GitHub Copilot API in some networks)
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - http_proxy=${HTTP_PROXY:-}
      - https_proxy=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1}
      - no_proxy=${NO_PROXY:-localhost,127.0.0.1}
    volumes:
      - ./data:/app/data:rw
    command: ["python", "chat.py"]
    networks:
      - freegpt-network
    profiles:
      - auth

  # Test service - runs all tests against the API
  test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: freegpt-test
    environment:
      - HOST=freegpt-api
      - PORT=${PORT:-8000}
      - FREEGPT_API_KEY=${FREEGPT_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - PYTHONUNBUFFERED=1
      - TEST_BASE_URL=http://freegpt-api:${PORT:-8000}
      # Proxy settings
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - http_proxy=${HTTP_PROXY:-}
      - https_proxy=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1,freegpt-api}
      - no_proxy=${NO_PROXY:-localhost,127.0.0.1,freegpt-api}
    volumes:
      # Mount test files
      - ./tests:/app/tests:ro
      - ./data:/app/data:ro
    depends_on:
      freegpt-api:
        condition: service_healthy
    command: ["sh", "-c", "cd /app && find . -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true && python -B -m pytest tests/ -v --tb=short"]
    networks:
      - freegpt-network
    profiles:
      - test

networks:
  freegpt-network:
    driver: bridge
